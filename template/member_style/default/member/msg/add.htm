{extend name="$member_style_layout" /}
{block name="title"}短消息{/block}
{block name="content"}

{if empty(input('isframe'))}
	{include file="msg/menu" /}
{else /}
	<style type="text/css">
	.qb_header{display:none;}
	</style>
{/if}

<style type="text/css">
.remind_msg{
	background:red;
	color:#FFF;
	line-height:30px;
	padding-left:20px;
	display:none;
}
</style>
<div class="remind_msg">提示：对方正在输入中，请不要离开当前窗口！</div>

<link rel="stylesheet" href="__STATIC__/layui/css/template.css" media="all">
<style type="text/css">
.layadmin-message-fluid{
	padding:0;
}
.layui-col-md12{
	background:#000;
	padding:10px;
	border-bottom:1px solid #eee;
}
.media-body{
	padding-bottom:15px;
	border-bottom:1px solid #eee;
}
.msg_title{color:#03A9F4;font-size:16px;}
</style>
<div class="layui-fluid layadmin-message-fluid">
  <div class="layui-row">
    <div class="layui-col-md12" style="padding-bottom:0px;">
      <div class="layui-form" style="padding:10px">
        <div class="layui-form-item layui-form-text">
          <div class="layui-input-block">
            <textarea name="desc"  placeholder="请输入内容" class="layui-textarea msgcontent"></textarea>
          </div>
        </div>

         <div class="layui-form-item" style="overflow: hidden;">
          <div class="layui-input-block layui-input-left" style=" float:left;">
           <input type="text" value="{$username}"  placeholder="请输入接收者的帐号" name="touser" id="touser" class="layui-input" onblur="get_touid()"> </div>
		  
          <div class="layui-input-block layui-input-right" style="float:right;">
            <button class="layui-btn" onclick="postmsg()">发送</button>
          </div>         
		   <div class="layui-input-block" style="margin-top:45px;"> <select name="select" onchange="change_user(this.options[this.selectedIndex].value)">
<option value="">快速选择常用联系人</option>
{volist name="linkman" id="tou_id"}
 <option value="{$tou_id|get_user_name}">{$tou_id|get_user_name}</option> 
{/volist}
</select>
          </div>
        </div>
      </div>
    </div>
    <div class="layui-col-md12 layadmin-homepage-list-imgtxt message-content sys_wapadd_msg_list001">
{qb:tag name="sys_wapadd_msg_list001" class="app\member\controller\Msg@showmore" union="uid=$touid,time,num" rows="5"}
		<div class="media-body" style="margin-bottom:20px;margin-top:10px;">
          <a href="{:get_url('user',['uid'=>$rs['uid']])}" class="media-left" style="float: left;">
             <img src="{$rs.from_icon}" onerror="this.src='__STATIC__/images/noface.png'" height="46px" width="46px">
          </a>
          <div class="pad-btm">
            <p class="fontColor"><a href="{:get_url('user',['uid'=>$rs['uid']])}">{$rs.from_username}</a></p>
            <p class="min-font">
              {$rs.create_time}
            </p>         
         </div>
          <p class='msg_title'>{$rs.title}</p>
          <p class="message-text">{$rs.content}</p>
       </div>
{/qb:tag}
    </div>
  </div>
</div>


<script type="text/javascript">

function change_user(value){
	if(value!=''){
		$("#touser").val(value);
		get_touid();
	}
}

function get_touid(){
	var name = $("#touser").val();
	if(name!=''){
		touid = 0;
		$.get("{:urls('index/wxapp.member/get_uid')}?name="+name,function(res){
			if(res.code==0){
				touid = res.data.uid;
			}else{
				layer.alert('当前用户不存在!');
			}
		});
	}	
}

var touid = "{$touid}";


function postmsg(){
	if(touid==""||touid==0){
		layer.alert('不知道你要发信息给谁?');
		return ;
	}

	var url = "{:urls('wxapp.msg/add')}";
	var content = $(".msgcontent").val();
	if(content==''){
		layer.alert('消息内容不能为空');
		return ;
	}
	$.post(url,{'uid':touid,'content':content,},function(res){		
		if(res.code==0){
			$(".msgcontent").val('');
			layer.msg('发送成功');
			{if input('isframe')}

				setTimeout(function(){
					//parent.layer.closeAll();
				},800);

			{else /}

			setTimeout(function(){
				//window.location.href = "{:urls('index')}";
			},500);

			{/if}
		    //$(".msglist").html( make_html(res.data) );
		}else{
			layer.alert('发送失败:'+res.msg);
		}
	});
}


var num = 0;
setInterval(function(){
	//console.log(5);
	$.get(get_msg_url+"1&time={:time()}&uid="+touid+"&num="+num,function(res){
		if(res.code==0){
			num++;
			if(res.data!="")$('.sys_wapadd_msg_list001').prepend(res.data);
		}
		if(res.ext.lasttime<3){	//3秒内对方还在当前页面的话,就提示当前用户不要关闭当前窗口
			$(".remind_msg").show();
		}else{
			$(".remind_msg").hide();
		}
	});
},1000);

var msg_page=1;
var get_msg_url = "{qb:url name='sys_wapadd_msg_list001' /}";

function showMoreMsg(){
  msg_page++;
  $.get(get_msg_url+msg_page,function(res){  
    console.log(res);
    console.log(res.data);
    if(res.code==0){
      if(res.data==''){
        layer.msg("已经显示完了！",{time:500});
      }else{
        $('.sys_wapadd_msg_list001').append(res.data);
        scroll_get = true;
      }
    }else{
      layer.msg(res.msg,{time:2500});
    }
  });
}


//滚动显示更多
var scroll_get = true;  //做个标志,不要反反复复的加载
$(document).ready(function () {
  $(window).scroll(function () {
    if (scroll_get==true &&  (400 + $(window).scrollTop())>($(document).height() - $(window).height())) {
      scroll_get = false;     
      layer.msg('内容加截中,请稍候',{time:1500});
      showMoreMsg();
    }
  });
});
</script>

{/block}