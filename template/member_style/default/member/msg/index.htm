{extend name="$member_style_layout" /}

{block name="title"}短消息{/block}
{block name="content"}

{include file="msg/menu" /}

<style type="text/css">
.tongji-msg dd{
	float:left; 
	width:50px;height:47px; 
}
.tongji-msg dd img{
	width:47px;height:47px; border-radius:100%;
}
 
.qb_member_ListType1 ol span.FL {
	color:#aaa;
	width:70%;
	padding-top:7px;
}
.tongji-msg .FL em{
	font-size:18px;font-weight:bold;color:#333;
	margin-bottom:8px;
}

.tongji-msg .FR em{
	display:block;
	margin-top:15px;
	border-radius:100%;
	text-align:center;
	line-height:22px;
	width:22px;
	height:22px;
	font-size:12px;
	background:#ddd;
	color:#333;
}
.tongji-msg .FR em.ck{
	background:red;
	color:#fff;
}

.tongji-msg .FR i{
	margin-top:12px;
	font-size:25px;
	color:#eee;
}
</style>

<div class="qb_member_Cnt tongji-msg sys_waplist_msg_list001">
{qb:tag name="sys_waplist_msg_list001" js="sys_waplist_msg_list001" class="app\member\controller\Msg@listuser" rows="10"}
	<ul class="qb_member_ListType1 list_{$rs.id}">
		<ol><dd class="user_icon"><a href="{:get_url('user',$rs.uid)}"><img src="{$rs.uid|get_user_icon}" onerror="this.src='__STATIC__/images/nobody.gif'"></a></dd>
			<span class="FL" onclick="open_msg({$rs.id})"><em>{$rs.uid?get_user_name($rs.uid):'系统消息'}</em><br>{$rs.title}</span>
			<span class="FR"><em class="shownum {$rs.new_num?'ck':''}">{if $rs.new_num} {$rs.new_num} {else /} {$rs.num>999?'99+':$rs.num} {/if}</em></span>
		</ol>		 
	</ul>
{/qb:tag}
</div>

<script type="text/javascript">
var msg_page = 1;
var get_msg_url = "{qb:url name='sys_waplist_msg_list001' /}";
var uid_array = [];
function showMoreMsg(){
  msg_page++;
  $.get(get_msg_url+msg_page,function(res){  
    //console.log(res);
    //console.log(res.data);
    if(res.code==0){
      if(res.data==''){
        layer.msg("已经显示完了！",{time:500});
      }else{
        $('.sys_waplist_msg_list001').append(res.data);
		sys_waplist_msg_list001(res);
        scroll_get = true;
      }
    }else{
      layer.msg(res.msg,{time:2500});
    }
  });
}

//异步加载被调用的函数
function sys_waplist_msg_list001(res){	
	$.each(res.ext.s_data,function(i,rs){
		//console.log(rs.uid);
		uid_array[rs.uid] = rs.id;
	});
}

//滚动显示更多
var scroll_get = true;  //做个标志,不要反反复复的加载
$(document).ready(function () {
  $(window).scroll(function () {
    if (scroll_get==true &&  (400 + $(window).scrollTop())>($(document).height() - $(window).height())) {
      scroll_get = false;     
      layer.msg('内容加截中,请稍候',{time:1500});
      showMoreMsg();
    }
  });
});

function open_msg(id){
	layer.open({
		type: 2,
		title:'信息详情',
		area:['95%','95%'],
		content: "{:urls('member/msg/show')}?isframe=1&id="+id,
	});
}

setInterval(function(){
	$.get(get_msg_url+"1",function(res){
		if(res.code==0){
			
			$.each(res.ext.s_data,function(i,rs){
				if(typeof(uid_array[rs.uid])=='undefined'||rs.id>uid_array[rs.uid]){
					$('.sys_waplist_msg_list001').html(res.data);
				}
				if(rs.new_num<1){
					$('.sys_waplist_msg_list001 .list_'+rs.id+' .shownum').removeClass('ck');
					$('.sys_waplist_msg_list001 .list_'+rs.id+' .shownum').html(rs.num>999?'99+':rs.num);
				}
				//console.log(rs.uid+'='+rs.id+'='+uid_array[rs.uid]);
				uid_array[rs.uid] = rs.id;
			});
		}
	});
},2000);

</script>
{/block}